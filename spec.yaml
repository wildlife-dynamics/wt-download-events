id: download_events
requirements:
  - name: ecoscope-workflows-core
    version: ">=0.22.2, <0.23.0"
    channel: https://repo.prefix.dev/ecoscope-workflows/
  - name: ecoscope-workflows-ext-ecoscope
    version: ">=0.22.2, <0.23.0"
    channel: https://repo.prefix.dev/ecoscope-workflows/
  - name: ecoscope-workflows-ext-custom
    version: ">=0.0.24, <0.1.0"
    channel: https://repo.prefix.dev/ecoscope-workflows-custom/
rjsf-overrides:
  properties:
    Generate Maps.properties.skip_map_generation.properties.skip.description: >-
      Skip generating maps for the events data. Recommended for large datasets to improve performance.
    Generate Maps.properties.base_map_defs.properties.base_maps.title: "Map Base Layers"
    Download Attachments.properties.skip_attachment_download.properties.skip.description: >-
      Skip downloading all attachments associated with the events.
    Download Attachments.properties.skip_attachment_download.properties.skip.default: true
    persist_events.properties.filename_prefix.default: "events"
    persist_events.properties.filetypes.default: ["geoparquet"]
    Process Events.properties.process_columns.properties.drop_columns.default: ["location", "end_time", "message", "provenance", "priority", "priority_label", "attributes", "comment", "patrol_segments", "updated_at", "state", "is_contained_in", "sort_at", "icon_id", "url", "image_url", "geojson", "related_subjects", "patrols", "reported_by"]
    Process Events.properties.process_columns.properties.drop_columns.description: >-
      Columns to drop from the event dataset, with defaults based on common Ecoscope practices. Modify the list based on your requirements.
  $defs:
    ValueGrouper: {
      description: "Use a categorical column to group data by. If you're unsure which columns are available, run the workflow once without grouping to see the data, then configure grouping in a subsequent run.",
      title: "Category",
      "type": "string"
    }
  uiSchema:
    Download Attachments.download_attachments.ui:options.label: false
    Download Attachments.download_attachments.attachments_subdir.items.ui:options.label: false
    Process Events.filter_events.filter_point_coords.items.ui:options.label: false
task-instance-defaults:
  skipif:
    conditions:
      - any_is_empty_df
      - any_dependency_skipped

workflow:
  - name: Workflow Details
    id: workflow_details
    task: set_workflow_details

  - name: Time Range
    id: time_range
    task: set_time_range
    partial:
      time_format: "%d %b %Y %H:%M:%S"

  - name: Extract Timezone Selection
    id: get_timezone
    task: get_timezone_from_time_range
    partial:
      time_range: ${{ workflow.time_range.return }}

  - name: Data Source
    id: er_client_name
    task: set_er_connection

  - name: Get Event Data
    id: get_event_data
    task: get_events
    partial:
      client: ${{ workflow.er_client_name.return }}
      time_range: ${{ workflow.time_range.return }}
      event_columns: null
      raise_on_empty: false
      include_details: true
      include_updates: false
      include_related_events: false
      include_display_values: true

  - title: Process Events
    type: task-group
    description: >-
      Process events by applying filters, SQL queries, etc. Note that the data here includes all the columns from the previous steps and the normalized event details.
    tasks:


      - name: "Convert to timezone"
        id: convert_to_user_timezone
        task: convert_values_to_timezone
        partial:
          df: ${{ workflow.get_event_data.return }}
          timezone: ${{ workflow.get_timezone.return }}
          columns: ["time"]

      - name: Extract reported_by_name from Events
        id: extract_reported_by
        task: extract_value_from_json_column
        partial:
          df: ${{ workflow.convert_to_user_timezone.return }}
          column_name: "reported_by"
          field_name_options: ["name"]
          output_type: "str"
          output_column_name: "reported_by_name"
          
      - name: Extract reported_by_subtype from Events
        id: extract_reported_by_subtype
        task: extract_value_from_json_column
        partial:
          df: ${{ workflow.extract_reported_by.return }}
          column_name: "reported_by"
          field_name_options: ["subject_subtype"]
          output_type: "str"
          output_column_name: "reported_by_subtype"

      - name: Process Event Details
        id: process_event_details
        task: process_events_details
        partial:
          df: ${{ workflow.extract_reported_by_subtype.return }}
          client: ${{ workflow.er_client_name.return }}
          map_to_titles: true

      - name: Normalize Event Details
        id: normalize_event_details
        task: normalize_json_column
        partial:
          df: ${{ workflow.process_event_details.return }}
          column: "event_details"
          skip_if_not_exists: true
          sort_columns: true

      - name: Remove Column Prefix Event Details
        id: drop_event_details_prefix
        task: drop_column_prefix
        partial:
          df: ${{ workflow.normalize_event_details.return }}
          prefix: "event_details__"
          duplicate_strategy: "suffix"

      ## Custom Processing Steps ##
      - name: Filter Event Relocations
        id: filter_events
        task: apply_reloc_coord_filter
        partial:
          df: ${{ workflow.drop_event_details_prefix.return }}
          roi_gdf: null
          roi_name: null
          reset_index: true

      - name: Preprocess Columns
        id: process_columns
        task: map_columns
        partial:
          df: ${{ workflow.filter_events.return }}
          rename_columns:
            time: event_time
          retain_columns: []

      - name: Apply SQL Query
        id: sql_query
        task: apply_sql_query
        partial:
          df: ${{ workflow.process_columns.return }}

      - name: Group Data
        id: groupers
        task: set_groupers

      - name: Add temporal index to Events
        id: events_add_temporal_index
        task: add_temporal_index
        partial:
          df: ${{ workflow.sql_query.return }}
          time_col: "event_time"
          groupers: ${{ workflow.groupers.return }}
          cast_to_datetime: true
          format: "mixed"

      - name: Split Events by Group
        id: split_event_groups
        task: split_groups
        partial:
          df: ${{ workflow.events_add_temporal_index.return }}
          groupers: ${{ workflow.groupers.return }}

  - name: Persist Events
    id: persist_events
    task: persist_df_wrapper
    partial:
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      sanitize: true
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.split_event_groups.return }}
    skipif:
      conditions:
        - never

  - title: Download Attachments
    type: task-group
    description: >-
      Download attachments associated with the events.
    tasks:
      - name: Skip Attachment Download
        id: skip_attachment_download
        task: maybe_skip_df
        partial:
          df: ${{ workflow.get_event_data.return }}

      - name: Download Attachments
        id: download_attachments
        task: download_event_attachments
        partial:
          client: ${{ workflow.er_client_name.return }}
          output_dir: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
          use_index_as_id: false
          event_gdf: ${{ workflow.skip_attachment_download.return }}
          skip_download: false
          attachments_subdir: "attachments"

  - title: Generate Maps
    type: task-group
    description: >-
      Generate maps to visualize the events data.
    tasks:

      - name: Skip Map Generation
        id: skip_map_generation
        task: maybe_skip_df
        mapvalues:
          argnames: df
          argvalues: ${{ workflow.split_event_groups.return }}

      - name: Events Colormap
        id: events_colormap
        task: apply_color_map
        partial:
          input_column_name: "event_type"
          colormap: "tab20b"
          output_column_name: "event_type_colormap"
        mapvalues:
          argnames: df
          argvalues: ${{ workflow.skip_map_generation.return }}
      

      # Rename columns for display
      - name: Rename columns for map tooltip display
        id: rename_display_columns
        task: map_columns
        partial:
          drop_columns: []
          retain_columns: []
          rename_columns:
            serial_number: "Event Serial"
            event_time: "Event Time"
            event_type_display: "Event Type"
            reported_by_name: "Reported By"
        mapvalues:
          argnames: df
          argvalues: ${{ workflow.events_colormap.return }}

      - name: "Set Events Map Title"
        id: set_events_map_title
        task: set_string_var
        partial:
          var: "Events Map"

      # Set base maps
      - name: " "
        id: base_map_defs
        task: set_base_maps

      # Grouped Events Map
      - name: Create map layer from grouped Events
        id: grouped_events_map_layer
        task: create_point_layer
        skipif:
          conditions:
            - any_is_empty_df
            - any_dependency_skipped
            - all_geometry_are_none
        partial:
          layer_style:
            fill_color_column: "event_type_colormap"
            get_radius: 5
          legend:
            label_column: "Event Type"
            color_column: "event_type_colormap"
          tooltip_columns: ["Event Serial", "Event Time", "Event Type", "Reported By"]
        mapvalues:
          argnames: geodataframe
          argvalues: ${{ workflow.rename_display_columns.return }}
      - name: Draw Ecomap from grouped Events
        id: grouped_events_ecomap
        task: draw_ecomap
        partial:
          title: null
          tile_layers: ${{ workflow.base_map_defs.return }}
          north_arrow_style:
            placement: "top-left"
          legend_style:
            title: "Event Type"
            format_title: false
            placement: "bottom-right"
          static: false
          max_zoom: 20
          widget_id: ${{ workflow.set_events_map_title.return }}
        mapvalues:
          argnames: geo_layers
          argvalues: ${{ workflow.grouped_events_map_layer.return }}
      - name: Persist grouped Events Ecomap as Text
        id: grouped_events_ecomap_html_url
        task: persist_text
        partial:
          root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
        mapvalues:
          argnames: text
          argvalues: ${{ workflow.grouped_events_ecomap.return }}
      - name: Create grouped Events Map Widget
        id: grouped_events_map_widget
        task: create_map_widget_single_view
        skipif:
          conditions:
            - never
        partial:
          title: ${{ workflow.set_events_map_title.return }}
        map:
          argnames: [view, data]
          argvalues: ${{ workflow.grouped_events_ecomap_html_url.return }}
      - name: Merge Events Map Widget Views
        id: grouped_events_map_widget_merge
        task: merge_widget_views
        partial:
          widgets: ${{ workflow.grouped_events_map_widget.return }}

  - name: Create Dashboard with Map Widgets
    id: events_dashboard
    task: gather_dashboard
    partial:
      details: ${{ workflow.workflow_details.return}}
      widgets:
        - ${{ workflow.grouped_events_map_widget_merge.return }}
      groupers: ${{ workflow.groupers.return }}
      time_range: ${{ workflow.time_range.return}}