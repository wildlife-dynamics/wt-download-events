{
  "properties": {
    "workflow_details": {
      "additionalProperties": false,
      "properties": {
        "name": {
          "title": "Workflow Name",
          "type": "string"
        },
        "description": {
          "default": "",
          "title": "Workflow Description",
          "type": "string"
        }
      },
      "required": [
        "name"
      ],
      "type": "object",
      "description": "Add information that will help to differentiate this workflow from another.",
      "title": "Workflow Details"
    },
    "time_range": {
      "additionalProperties": false,
      "properties": {
        "since": {
          "format": "date-time",
          "title": "Since",
          "type": "string",
          "description": "The start time"
        },
        "until": {
          "format": "date-time",
          "title": "Until",
          "type": "string",
          "description": "The end time"
        },
        "timezone": {
          "allOf": [
            {
              "$ref": "#/$defs/TimezoneInfo"
            }
          ],
          "default": null,
          "title": "Timezone"
        }
      },
      "required": [
        "since",
        "until"
      ],
      "type": "object",
      "description": "Choose the period of time to analyze.",
      "title": "Time Range"
    },
    "er_client_name": {
      "additionalProperties": false,
      "properties": {
        "data_source": {
          "$ref": "#/$defs/EarthRangerConnection",
          "title": "",
          "description": "Select one of your configured data sources."
        }
      },
      "required": [
        "data_source"
      ],
      "type": "object",
      "title": "Data Source"
    },
    "get_event_data": {
      "additionalProperties": false,
      "properties": {
        "event_types": {
          "items": {
            "type": "string"
          },
          "title": "Event Types",
          "type": "array",
          "description": "Specify the event type(s) to analyze (optional). Leave this section empty to analyze all event types."
        },
        "include_null_geometry": {
          "default": true,
          "title": "Include Events Without a Geometry (point or polygon)",
          "type": "boolean"
        }
      },
      "required": [
        "event_types"
      ],
      "type": "object",
      "title": "Get Event Data"
    },
    "Process Events": {
      "type": "object",
      "description": "Process events by applying filters, SQL queries, etc. Note that the data here includes all the columns from the previous steps and the normalized event details.",
      "ecoscope:task_group": true,
      "properties": {
        "filter_events": {
          "additionalProperties": false,
          "properties": {
            "bounding_box": {
              "allOf": [
                {
                  "$ref": "#/$defs/BoundingBox"
                }
              ],
              "default": {
                "min_y": -90.0,
                "max_y": 90.0,
                "min_x": -180.0,
                "max_x": 180.0
              },
              "title": "Bounding Box",
              "description": "Filter events to inside these bounding coordinates.",
              "ecoscope:advanced": true
            },
            "filter_point_coords": {
              "default": [],
              "items": {
                "$ref": "#/$defs/Coordinate"
              },
              "title": "Filter Exact Point Coordinates",
              "type": "array",
              "description": "By adding a filter, the workflow will not include events recorded at the specified coordinates.",
              "ecoscope:advanced": true
            }
          },
          "required": [],
          "type": "object",
          "title": "Filter Event Relocations"
        },
        "process_columns": {
          "additionalProperties": false,
          "properties": {
            "drop_columns": {
              "default": [
                "location",
                "end_time",
                "message",
                "provenance",
                "priority",
                "priority_label",
                "attributes",
                "comment",
                "patrol_segments",
                "updated_at",
                "state",
                "is_contained_in",
                "sort_at",
                "icon_id",
                "url",
                "image_url",
                "geojson",
                "related_subjects",
                "patrols",
                "reported_by"
              ],
              "items": {
                "type": "string"
              },
              "title": "Drop Columns",
              "type": "array",
              "description": "Columns to drop from the event dataset, with defaults based on common Ecoscope practices. Modify the list based on your requirements.",
              "ecoscope:advanced": true
            }
          },
          "required": [],
          "type": "object",
          "title": "Preprocess Columns"
        },
        "sql_query": {
          "additionalProperties": false,
          "properties": {
            "query": {
              "default": "",
              "title": "SQL Query",
              "type": "string",
              "description": "SQL query string to apply to the DataFrame. Leaves it unchanged when the field is emptyUse 'df' as the table name in the query.",
              "ecoscope:advanced": true
            },
            "columns": {
              "default": null,
              "items": {
                "type": "string"
              },
              "title": "Columns",
              "type": "array",
              "description": "Optional list of column names to include in the SQL query context. If specified, only these columns will be available in the 'df' table for querying. Use this to exclude columns with unsupported data types (list, dict) that cannot be stored in SQLite. If not specified, all columns are included.",
              "ecoscope:advanced": true
            }
          },
          "required": [],
          "type": "object",
          "title": "Apply SQL Query"
        },
        "groupers": {
          "additionalProperties": false,
          "properties": {
            "groupers": {
              "default": null,
              "items": {
                "anyOf": [
                  {
                    "$ref": "#/$defs/ValueGrouper"
                  },
                  {
                    "$ref": "#/$defs/TemporalGrouper"
                  },
                  {
                    "$ref": "#/$defs/SpatialGrouper"
                  }
                ],
                "title": "Group by"
              },
              "title": " ",
              "type": "array",
              "description": "            Specify how the data should be grouped to create the views for your dashboard.\n            This field is optional; if left blank, all the data will appear in a single view.\n            "
            }
          },
          "type": "object",
          "required": [],
          "title": "Group Data"
        }
      }
    },
    "persist_events": {
      "additionalProperties": false,
      "properties": {
        "filetypes": {
          "default": [
            "csv"
          ],
          "items": {
            "enum": [
              "csv",
              "gpkg",
              "geoparquet"
            ],
            "type": "string"
          },
          "title": "Filetypes",
          "type": "array",
          "description": "The output format",
          "uniqueItems": true
        },
        "filename_prefix": {
          "default": "events",
          "title": "Filename Prefix",
          "type": "string",
          "description": "            Optional filename prefix to persist text to within the `root_path`.\n            We will always add a suffix based on the dataframe content hash to avoid duplicates.\n            ",
          "ecoscope:advanced": true
        }
      },
      "required": [],
      "type": "object",
      "title": "Persist Events"
    },
    "Download Attachments": {
      "type": "object",
      "description": "Download attachments associated with the events.",
      "ecoscope:task_group": true,
      "properties": {
        "skip_attachment_download": {
          "additionalProperties": false,
          "properties": {
            "skip": {
              "default": true,
              "title": "Skip",
              "type": "boolean",
              "description": "Skip downloading all attachments associated with the events."
            }
          },
          "required": [],
          "type": "object",
          "title": "Skip Attachment Download"
        }
      }
    },
    "Generate Maps": {
      "type": "object",
      "description": "Generate maps to visualize the events data.",
      "ecoscope:task_group": true,
      "properties": {
        "skip_map_generation": {
          "additionalProperties": false,
          "properties": {
            "skip": {
              "default": false,
              "title": "Skip",
              "type": "boolean",
              "description": "Skip generating maps for the events data. Recommended for large datasets to improve performance."
            }
          },
          "required": [],
          "type": "object",
          "title": "Skip Map Generation"
        },
        "base_map_defs": {
          "additionalProperties": false,
          "properties": {
            "base_maps": {
              "default": [
                {
                  "url": "https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",
                  "opacity": 1
                },
                {
                  "url": "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
                  "opacity": 0.5
                }
              ],
              "items": {
                "title": "Base Layer",
                "anyOf": [
                  {
                    "properties": {
                      "url": {
                        "default": "https://tile.openstreetmap.org/{z}/{x}/{y}.png",
                        "title": "Preset Layer URL",
                        "type": "string",
                        "const": "https://tile.openstreetmap.org/{z}/{x}/{y}.png",
                        "enum": [
                          "https://tile.openstreetmap.org/{z}/{x}/{y}.png"
                        ]
                      },
                      "opacity": {
                        "default": 1,
                        "description": "Set layer transparency from 1 (fully visible) to 0 (hidden).",
                        "ecoscope:advanced": true,
                        "maximum": 1.0,
                        "minimum": 0.0,
                        "title": "Layer Opacity",
                        "type": "number"
                      }
                    },
                    "title": "Open Street Map",
                    "type": "object"
                  },
                  {
                    "properties": {
                      "url": {
                        "default": "https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}",
                        "title": "Preset Layer URL",
                        "type": "string",
                        "const": "https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}",
                        "enum": [
                          "https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}"
                        ]
                      },
                      "opacity": {
                        "default": 1,
                        "description": "Set layer transparency from 1 (fully visible) to 0 (hidden).",
                        "ecoscope:advanced": true,
                        "maximum": 1.0,
                        "minimum": 0.0,
                        "title": "Layer Opacity",
                        "type": "number"
                      }
                    },
                    "title": "Roadmap",
                    "type": "object"
                  },
                  {
                    "properties": {
                      "url": {
                        "default": "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
                        "title": "Preset Layer URL",
                        "type": "string",
                        "const": "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
                        "enum": [
                          "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"
                        ]
                      },
                      "opacity": {
                        "default": 1,
                        "description": "Set layer transparency from 1 (fully visible) to 0 (hidden).",
                        "ecoscope:advanced": true,
                        "maximum": 1.0,
                        "minimum": 0.0,
                        "title": "Layer Opacity",
                        "type": "number"
                      }
                    },
                    "title": "Satellite",
                    "type": "object"
                  },
                  {
                    "properties": {
                      "url": {
                        "default": "https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",
                        "title": "Preset Layer URL",
                        "type": "string",
                        "const": "https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",
                        "enum": [
                          "https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}"
                        ]
                      },
                      "opacity": {
                        "default": 1,
                        "description": "Set layer transparency from 1 (fully visible) to 0 (hidden).",
                        "ecoscope:advanced": true,
                        "maximum": 1.0,
                        "minimum": 0.0,
                        "title": "Layer Opacity",
                        "type": "number"
                      }
                    },
                    "title": "Terrain",
                    "type": "object"
                  },
                  {
                    "properties": {
                      "url": {
                        "default": "https://tiles.arcgis.com/tiles/POUcpLYXNckpLjnY/arcgis/rest/services/landDx_basemap_tiles_mapservice/MapServer/tile/{z}/{y}/{x}",
                        "title": "Preset Layer URL",
                        "type": "string",
                        "const": "https://tiles.arcgis.com/tiles/POUcpLYXNckpLjnY/arcgis/rest/services/landDx_basemap_tiles_mapservice/MapServer/tile/{z}/{y}/{x}",
                        "enum": [
                          "https://tiles.arcgis.com/tiles/POUcpLYXNckpLjnY/arcgis/rest/services/landDx_basemap_tiles_mapservice/MapServer/tile/{z}/{y}/{x}"
                        ]
                      },
                      "opacity": {
                        "default": 1,
                        "description": "Set layer transparency from 1 (fully visible) to 0 (hidden).",
                        "ecoscope:advanced": true,
                        "maximum": 1.0,
                        "minimum": 0.0,
                        "title": "Layer Opacity",
                        "type": "number"
                      }
                    },
                    "title": "LandDx",
                    "type": "object"
                  },
                  {
                    "properties": {
                      "url": {
                        "default": "https://server.arcgisonline.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer/tile/{z}/{y}/{x}",
                        "title": "Preset Layer URL",
                        "type": "string",
                        "const": "https://server.arcgisonline.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer/tile/{z}/{y}/{x}",
                        "enum": [
                          "https://server.arcgisonline.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer/tile/{z}/{y}/{x}"
                        ]
                      },
                      "opacity": {
                        "default": 1,
                        "description": "Set layer transparency from 1 (fully visible) to 0 (hidden).",
                        "ecoscope:advanced": true,
                        "maximum": 1.0,
                        "minimum": 0.0,
                        "title": "Layer Opacity",
                        "type": "number"
                      }
                    },
                    "title": "USGS Hillshade",
                    "type": "object"
                  },
                  {
                    "properties": {
                      "url": {
                        "default": "https://example.tiles.com/{z}/{x}/{y}.png",
                        "description": "The URL of a publicly accessible tiled raster service.",
                        "pattern": "https?:\\/\\/(www\\.)?[-a-zA-Z0-9@:%._\\+~#=]{1,256}\\.[a-zA-Z0-9()]{1,6}([-a-zA-Z0-9()@:%_\\+.~#?&//=\\{\\}]*)",
                        "title": "Custom Layer URL",
                        "type": "string"
                      },
                      "opacity": {
                        "default": 1,
                        "description": "Set layer transparency from 1 (fully visible) to 0 (hidden).",
                        "ecoscope:advanced": true,
                        "maximum": 1.0,
                        "minimum": 0.0,
                        "title": "Custom Layer Opacity",
                        "type": "number"
                      },
                      "max_zoom": {
                        "default": null,
                        "description": "Set the maximum zoom level to fetch tiles for.",
                        "title": "Custom Layer Max Zoom",
                        "type": "integer"
                      },
                      "min_zoom": {
                        "default": null,
                        "description": "Set the minimum zoom level to fetch tiles for.",
                        "title": "Custom Layer Min Zoom",
                        "type": "integer"
                      }
                    },
                    "title": "Custom Layer (Advanced)",
                    "type": "object"
                  }
                ]
              },
              "title": "Map Base Layers",
              "type": "array",
              "description": "Select tile layers to use as base layers in map outputs. The first layer in the list will be the bottommost layer displayed.",
              "ecoscope:advanced": true
            }
          },
          "type": "object",
          "required": [],
          "title": " "
        }
      }
    }
  },
  "$defs": {
    "TimezoneInfo": {
      "properties": {
        "label": {
          "title": "Label",
          "type": "string"
        },
        "tzCode": {
          "title": "Tzcode",
          "type": "string"
        },
        "name": {
          "title": "Name",
          "type": "string"
        },
        "utc": {
          "title": "Utc",
          "type": "string"
        }
      },
      "required": [
        "label",
        "tzCode",
        "name",
        "utc"
      ],
      "title": "TimezoneInfo",
      "type": "object"
    },
    "EarthRangerConnection": {
      "properties": {
        "name": {
          "title": "Data Source",
          "type": "string"
        }
      },
      "required": [
        "name"
      ],
      "title": "EarthRangerConnection",
      "type": "object"
    },
    "BoundingBox": {
      "properties": {
        "min_y": {
          "default": -90.0,
          "ecoscope:advanced": true,
          "title": "Min Latitude",
          "type": "number"
        },
        "max_y": {
          "default": 90.0,
          "ecoscope:advanced": true,
          "title": "Max Latitude",
          "type": "number"
        },
        "min_x": {
          "default": -180.0,
          "ecoscope:advanced": true,
          "title": "Min Longitude",
          "type": "number"
        },
        "max_x": {
          "default": 180.0,
          "ecoscope:advanced": true,
          "title": "Max Longitude",
          "type": "number"
        }
      },
      "title": "BoundingBox",
      "type": "object"
    },
    "Coordinate": {
      "properties": {
        "y": {
          "description": "Example -0.15293",
          "title": "Latitude",
          "type": "number"
        },
        "x": {
          "description": "Example 37.30906",
          "title": "Longitude",
          "type": "number"
        }
      },
      "required": [
        "y",
        "x"
      ],
      "title": "Coordinate",
      "type": "object"
    },
    "SpatialGrouper": {
      "title": "Spatial Regions",
      "type": "string"
    },
    "TemporalGrouper": {
      "oneOf": [
        {
          "const": "%Y",
          "title": "Year (example: 2024)"
        },
        {
          "const": "%B",
          "title": "Month (example: September)"
        },
        {
          "const": "%Y-%m",
          "title": "Year and Month (example: 2023-01)"
        },
        {
          "const": "%j",
          "title": "Day of the year as a number (example: 365)"
        },
        {
          "const": "%d",
          "title": "Day of the month as a number (example: 31)"
        },
        {
          "const": "%A",
          "title": "Day of the week (example: Sunday)"
        },
        {
          "const": "%H",
          "title": "Hour (24-hour clock) as number (example: 22)"
        },
        {
          "const": "%Y-%m-%d",
          "title": "Date (example: 2025-01-31)"
        }
      ],
      "title": "Time",
      "type": "string"
    },
    "ValueGrouper": {
      "description": "Use a categorical column to group data by. If you're unsure which columns are available, run the workflow once without grouping to see the data, then configure grouping in a subsequent run.",
      "title": "Category",
      "type": "string"
    }
  },
  "uiSchema": {
    "workflow_details": {
      "ui:order": [
        "name",
        "description"
      ]
    },
    "time_range": {
      "ui:order": [
        "since",
        "until",
        "timezone"
      ]
    },
    "get_event_data": {
      "ui:order": [
        "event_types",
        "include_null_geometry"
      ]
    },
    "Process Events": {
      "ui:order": [
        "filter_events",
        "process_columns",
        "sql_query",
        "groupers"
      ],
      "filter_events": {
        "ui:order": [
          "bounding_box",
          "filter_point_coords"
        ],
        "filter_point_coords": {
          "items": {
            "ui:options": {
              "label": false
            }
          }
        }
      },
      "sql_query": {
        "ui:order": [
          "query",
          "columns"
        ]
      }
    },
    "persist_events": {
      "ui:order": [
        "filetypes",
        "filename_prefix"
      ]
    },
    "Generate Maps": {
      "ui:order": [
        "skip_map_generation",
        "base_map_defs"
      ]
    },
    "ui:order": [
      "workflow_details",
      "time_range",
      "er_client_name",
      "get_event_data",
      "Process Events",
      "persist_events",
      "Download Attachments",
      "Generate Maps"
    ],
    "Download Attachments": {
      "download_attachments": {
        "ui:options": {
          "label": false
        },
        "attachments_subdir": {
          "items": {
            "ui:options": {
              "label": false
            }
          }
        }
      }
    }
  },
  "additionalProperties": false
}
