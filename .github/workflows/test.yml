name: Test Workflow

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pixi
        uses: prefix-dev/setup-pixi@v0.8.1
        with:
          pixi-version: latest
          manifest-path: ecoscope-workflows-er-events-workflow/pixi.toml

      - name: Create output directory
        run: mkdir -p ${{ runner.temp }}/outputs

      - name: Run workflow with case1 parameters
        working-directory: ecoscope-workflows-er-events-workflow
        env:
          ECOSCOPE_WORKFLOWS_RESULTS: file://${{ runner.temp }}/outputs
          ecoscope_workflows__connections__earthranger__mep_dev__server: ${{ vars.MEP_DEV_SITE }}
          ecoscope_workflows__connections__earthranger__mep_dev__username: ${{ vars.MEP_DEV_USER }}
          ecoscope_workflows__connections__earthranger__mep_dev__password: ${{ secrets.MEP_DEV_PASSWORD }}
        run: |
          pixi run -e default python \
            -m ecoscope_workflows_er_events_workflow.cli run \
            --config-file ../test-cases/case1/param.yaml \
            --execution-mode sequential

      - name: Validate result.json
        run: |
          # Check if result.json was created
          if [ ! -f "${{ runner.temp }}/outputs/result.json" ]; then
            echo "Error: result.json was not created"
            exit 1
          fi

          # Validate that result is not empty and error is null
          RESULT=$(jq -r '.result' ${{ runner.temp }}/outputs/result.json)
          ERROR=$(jq -r '.error' ${{ runner.temp }}/outputs/result.json)

          if [ "$RESULT" == "null" ] || [ "$RESULT" == "{}" ] || [ "$RESULT" == "[]" ]; then
            echo "Error: result is empty or null"
            echo "Actual result.json:"
            cat ${{ runner.temp }}/outputs/result.json
            exit 1
          fi

          if [ "$ERROR" != "null" ]; then
            echo "Error: error field is not null"
            echo "Error value: $ERROR"
            echo "Actual result.json:"
            cat ${{ runner.temp }}/outputs/result.json
            exit 1
          fi

          echo "Success: result is not empty and error is null"
          echo "Result.json:"
          cat ${{ runner.temp }}/outputs/result.json

      - name: Upload result artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            ${{ runner.temp }}/outputs/result.json
            __result_snapshot__/case1/result.json
